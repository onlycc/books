# 接入网

接入网：连接互联网与家庭、公司网络的通信线路。家用的接入网有ADSL,FTTH,CATV,ISDN,电话线等；公司则还有可能使用专线。

家庭和公司的内网是通过接入网连接到网络运营商的。

互联网可以理解为家庭、公司网络的放大版。

但是他们之间也有不同之处：转发设备之间的距离和路由维护方式不同。

家庭或公司的转发设备之间的距离几十米到几百米，可以延长以太网线就可以到达相邻的转发设备。

互联网的实体是由多个运营商网络相互连接组成的。ADSL,FTTH等接入网是与用户签约的运营商设备相连，这些设备称为POP（接入点）。

#### ADSL
- ADSL：Asymmetric Digital Subscriber Line，不对称数字用户线。它是一种利用架设在电线杆上的金属电话线来进行高速通信的技术，它的上行方向（用户到互联网）和下行方向（互联网到用户）的通信速率是不对称的。

  > 互联网接入路由器会在网络包前面加上MAC 头部、PPPoE 头部、PPP 头部总共3 种头部， 然后发送给ADSL Modem（PPPoE 方式下）。
  
  电话线传入的信号是语音信号和ADSL信号混合在一起的，通过分离器进行分离。分离掉ADSL使用的高频信号。

- FTTH：Fiber To The Home，光纤到户。

#### 光纤

将数字信号转成电信号，电信号转换成光信号。利用光敏元件，根据光的亮度产生不同的电压（光亮产生高电压，光暗产生低电压）。

#### 用户认证和配置下发

ADSL,FTTH接入网到达运营商的BAS（进化型的路由器），都需要先输入用户名和密码，登录之后才能访问互联网。
BAS使用PPPoE（由传统电话拨号上网上使用的PPP协议发展来的）的方式来实现登录操作的。PPPoE是将PPP消息装入以太网包进行传输的方式。

ADSL和FTTH接入方式也是需要为计算机分配公有地址才能上网。

#### 网络包通过接入网之后，到达运营商POP的路由器。

NOC是运营商的核心设备，从POP传来的网络包都会集中到这里，并从这里被转发到离目的地更近的POP，或者是转发到其他的运营商。

经过几次转发之后，网络包就到达了Web服务器所在的POP的路由器，然后从这里被继续转发到Web服务器。

> POP和NOC遍布全国各地，它们各自的规模有大有小，但看起来跟公司里的机房没什么太大区别，都是位于一幢建筑物中的，其中的路由器或者通过线路直接连接，或者通过交换机进行连接，这些和公司以及家庭网络都是相同的。

互联网中不能单纯采用最短路由，而是需要一种能够阻止某些来源的网络包的机制，互联网的路由交换机制就具有这样的功能。

运营商就可以只将路由信息提供给那些交了费的运营商，那些没交费的运营商也就无法将网络包发送过来了。


# 防火墙的结构和原理

防火墙：只允许发往特定服务器中的特定应用程序的包可以通过，屏蔽其他的包。 

防火墙可分为包过滤、应用层网关、电路层网关等几种方式。主流的是采用包过滤方式。

#### 如何设置包过滤的规则

网络包的头部包含了用于控制通信操作的控制信息。

- 根据接收方和发送方地址判断包的流向，并设置是允许还是阻止。

- 通过端口号限定应用程序，如果要允许应用程序的可以访问，把应用程序的端口号设置到防火墙中并允许通过。

- 通过控制位判断连接方向 
  > Web使用的TCP协议是双向收发网络包的，因此如果单纯地阻止从Web 服务器发往互联网的包，则从互联网访问Web 服务器的操作也会受到影响而无法进行。 TCP控制位中SYN=1/ACK=0就表示TCP连接的第一个包，就可以阻止Web服务器发往互联网。

> ACK 用于通知发送方数据已经正确接收

对阻止的包进行记录对于路由器来说负担也比较大，因此才出现了专用的硬件和软件。如果规则不复杂，也不需要记录日志，那么用内置包过滤功能的普通路由器来充当防火墙也是可以的。


#### 防火墙无法抵御的攻击
假设Web服务器在收到含有特定数据的包时会引起宕机。但是防火墙只关心包的起点和终点，因此即便包中含有特定数据，防火墙也无法发现，于是包就被放了。

这个问题的根源在于*Web服务器程序的Bug*，因此修复Bug防止宕机就是其中一种方法。这类Bug中，危险性较高的会作为安全漏洞公布出来，开发者会很快发布修复了Bug的新版本，因此持续关注安全漏洞信息并更新软件的版本是非常重要的。

另一种方法就是在防火墙之外部署用来检查包的内容并阻止有害包的设备或软件。

---

# 负载均衡

当服务器的访问量上升时，增加服务器线路的带宽是有效的，但是并不是网络变快了就可以解决所有问题。高速线路会传输大量的网络包，这会导致服务器的性能跟不上。

在这种情况下，使用多台服务器来分担负载的方法更有效。这种架构统称为分布式架构。

方法1: 轮询，通过这种方式可以将访问平均分配给所有的服务器。

  > DNS服务器来分配，则每次查询时DNS服务器都会按顺序返回不同的IP 地址。

  存在的问题：
  1. 如果有一台服务器挂了，DNS还是会返回这台服务器的IP。
  2. 有些页面是动态生成的，操作跨页面，访问期间服务器发生了变化会导致操作无法进行。

方法二：负载均衡器

使用负载均衡器的IP代替Web服务器的IP地址注册到DNS服务器上。负载均衡器来判断将请求转发到哪一台Web服务器上。

  - 根据Web服务器的负载来判断，避免负载集中在某一台服务器上。
  - 判断请求质之间是否有相关性，让请求一直保持一个地址。

方法三：缓存服务器

将整个系统按功能分为不同的服务器：Web服务器，数据库服务器。

缓存服务器是一台通过代理机制对数据进行缓存的服务器。代理介于Web服务器和客户端之间，具有对Web服务器访问进行中转的功能。可以将Web服务器返回的数据保存在磁盘中，并且代替Web服务器将磁盘中的数据返回给客户端。

缓存服务器需要和负载均衡器一样代替Web服务器被注册到DNS服务器中。

客户端发来请求，缓存服务器会检查请求消息是否在缓存中：

```html
客户端 ===> 缓存服务器 ===> Web服务器
*未命中缓存*
1. 缓存服务器在HTTP头部字段中添加一个Via字段，表示这个消息经过缓存服务器转发，将消息转发给Web服务器。

2. 缓存中没有数据：没有If-Modified-Since字段/或Web服务器端数据发生变化时，直接返回页面数据。

3. 将内存保存到缓存中，并记录保存时间，缓存服务器转发给客户端响应内容，在响应头中添加Via字段。

*命中缓存*
1. 缓存服务器检查是否有缓存，有缓存，添加一个If-Modified-Since头部字段，并将请求转发给Web服务器，询问Web服务器用户的请求数据是否发生了变化。

2. Web服务器会根据If-Modified-Since的值与服务器上的数据的最后更新时间进行比较，如果数据没有变化，返回一个没有发生变化的响应消息（304 Not Modified）。（Web服务器只是查询了数据的最后更新时间，没有返回页面数据，负担小，响应消息也短）

3. 缓存服务器就把缓存的数据直接返回给客户端。

4. 如果数据更新了，Web服务器会返回最新的数据，缓存服务器会把数据保存到缓存中，发送给客户端。
```
---
# 代理

代理（Proxy）本来的意思并不是“转发”消息，而是先把消息收下来，然后“伪装”成原始客户端向Web服务器发出访问请求。

正向代理 Forwad proxy：放在客户端一侧的代理。

  使用正向代理需要在浏览器中进行设置

  > 目的：缓存；实现防火墙，防止来自互联网的非法入侵。

  阻止互联网和公司内网之间的所有包，导致内网无法访问外网。可以使用代理，接收来自客户端的请求消息，然后转发到互联网中。就可以利用代理的缓存，之前访问过的数据可以从代理服务器获得。 

  可以禁止员工访问危险的网站或者和工作无关的网站。无代理是URI值包含文件名、目录名，有代理时是完整的网址。

反向代理 Reverse proxy:  

  将请求消息中的URI中的目录名和Web服务器进行关联，使得代理能够转发一般的不包含完整网址的请求消息。

透明代理 Transparent proxy:

  查看请求消息的包头部，获取接收方的IP地址。集合了正向和反向代理的优点。

  将透明代理放在请求消息从浏览器传输到Web服务器的路径中，当消息经过时进行拦截。

---

# 内容分发服务 CDN

缓存服务器放在服务端，可以减轻Web服务器的负载，但是无法减少互联网的流量。

如果再客户端部署缓存服务器，就可以不受或少受拥塞点的影响，让网络流量更加稳定，特别是当访问内容中含有大量的图片或视频效果更加明显。

Web运营者和网络运营商签约，将自己控制的缓存服务器放在客户端的运营商处。
一些专门从事相关 服务的厂商CDSP他们部署缓存服务器，租借给Web服务运营者，这种服务称为内容分发服务。

只要Web服务器与缓存服务器建立关联，那么当客户端访问Web服务器时，实际上就是在访问CDSP的缓存服务器了。

## 通过重定向服务器分配访问目标

HTTP的头部字段Location，将Web服务器访问引导到另一台服务器上的操作称为重定向。

重定向服务器收集来自各个路由器的路由信息，并根据这些信息找到最近的缓存服务器，然后将缓存服务器的地址放在Location字段中返回响应。（会增大消息的交互次数）

内容分发服务采用的缓存服务器就具备这样的功能:Web服务器在原始数据发生更新时，立即通知缓存服务器，使得缓存服务器上的数据一直保持最新状态。

---
# 服务器

## 服务器和客户端的区别
服务器可以分为很多的种类，硬件和操作系统与客户端的有所不同。但是在网络相关的部分：网卡、协议栈、Socket库等功能和客户端并无二致。

服务器可以同时和多个客户端进行通信。服务器的操作系统具有多任务、多线程功能，可以同时运行多个程序。

服务器结构：
- 等待连接模块：创建套接字，进入等待连接的暂停状态。

- 负载和客户端通信模块：每一次有新的客户端发起连接，都会启动一个新的客户端通信模块。或者事先启动几个客户端通信模块，从空闲的模块中挑选一个来处理。

```html
等待连接模块
1. 创建套接字：<描述符>=socket(<IPv4>,<TCP>...)
2. 将套接字设置为等待连接状态，bind(<描述符>,<端口号>...), listen(<描述符>)；接受连接<描述符2>=accept(<描述符>...)

// 协议栈采用了这种创建套接字的新副本，并让客户端连接到这个新副本上的方法。使用客户端IP，端口，服务端IP，端口来确定某个套接字。

使用描述符来指代套接字的原因如下：
（1）等待连接的套接字中没有客户端IP 地址和端口号
（2）使用描述符这一种信息比较简单

客户端通信模块
3. 收发数据: read/write
4. 断开管道并删除套接字：close
```

## 服务器接收操作：

- 网卡的MAC模块将网络包从信号还原为数字信息，校验FCS(帧校验序列)并存入缓冲区。检查MAC头部确认接收方的MAC地址。

- 网卡需要通过中断将网络包到达的事件通知给CPU。

- CPU就会暂停当前的工作，并切换到网卡的任务。

- 网卡驱动开始工作，从网卡缓冲区读包，根据MAC头部的以太类型字段判断协议种类，调用负责该协议的软件（TCP/IP协议栈）。

- IP模块先工作，协议栈的IP模块会检查IP头部：

  （1） 判断是不是发给自己的；

  （2） 判断网络包是否经过分片；

  （3） 将包转交给TCP模块或UDP模块。

- 如果收到的是发起连接的包，则TCP 模块会:

  （1） 确认TCP头部的控制位SYN；

  （2） 检查接收方端口号；

  （3） 为相应的等待连接套接字复制一个新的副本；

  （4） 记录发送方IP 地址和端口号等信息。

- 收到数据包时，TCP 模块会

  （1） 根据收到的包的发送方IP 地址、发送方端口号、接收方IP 地址、接收方端口号找到相对应的套接字；

  （2） 将数据块拼合起来并保存在接收缓冲区中；

  （3） 向客户端返回ACK。

## 将请求的URI转换为实际的文件名

URI中的路径如果完全按照磁盘的路径，意味着整个磁盘的内容都全部暴露了，很危险。需要一种特殊的机制：URI写的是一个虚拟目录结构下的路径名。

先查询虚拟目录与实际目录的对应关系，将URI转换成实际的文件名。

## 浏览器接收响应消息并显示内容

通过响应的数据类型判断其中的内容：

Content-Type头部字段判断数据类型（MIME 多用途因特网邮件扩充 规格定义的），检查Content-Encoding；还需要结合其他信息综合判断数据类型：扩展名，数据内容的格式等。
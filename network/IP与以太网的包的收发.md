# IP与以太网的包的收发

包的基本结构 = 头部（控制信息） + 数据 

1. 发送方的网络设备会负责创建包：生成含有正确控制信息的头部+要发送的数据。

2. 包被发送到最近的网络转发设备，转发设备根据头部信息判断接下来要发往哪里。 ... 经过多个转发设备的接力之后，包到达了接收方的网络设备。

> 路由器根据目标地址判断下一个路由器的位置。路由器中有一张IP协议的表，可以根据这张表以及IP头部中记录的目的信息查出接下来要发往哪一个路由器的MAC地址，改写MAC头部。

MAC头部包含通过以太网的局域网将包传输至最近的路由器所需的控制信息。

集线器在子网中将网络包传输下一个路由。集线器是根据以太网协议工作的设备。

IP模块负责添加两个头部：
- MAC头部（包含MAC地址，用于以太网协议，子网中的以太网协议将包传输到下一个转发设备）
- IP头部（包含IP地址，用于IP协议，IP协议根据目标地址判断下一个IP转发设备的位置）

网卡的网络包有01组成的数字信息，网卡将数字信息转换为电信号或光信号，通过网线或光纤发送出去。

## IP模块
IP模块接受TCP模块的委托负责包的收发工作，它会生成IP头部并附加在TCP头部前面。

IP地址是从TCP模块拿到的，TCP是从应用程序拿到的。

路由器使用路由表判断下一个路由器的位置：查询路由表 route print。

### 通过ARP查询目标路由器的MAC地址
ARP: Address Resolution Protocol 地址解析协议

ARP利用广播对所有设备提问，这个IP地址是谁的，把MAC地址告诉我。将查询的结果放在ARP缓存中,  过几分钟会被删除。 arp -a


### 以太网
以太网是一种为多台计算机能够彼此自由和廉价地相互通信而设计的通信技术。本质是一根网线。
现在的是使用交互式集线器，信号只会流到指定的MAC地址的设备，不会到达其他设备。

### 网卡发送信号

网卡通电之后需要进行初始化，需要网卡驱动程度对硬件进行初始化操作，然后硬件才能进入可以使用的状态。

网卡的ROM： 保存全世界唯一的MAC地址，生产网卡时候写入的。由网卡驱动程序读取并分配给MAC模块。

1. 网卡驱动从IP模块获取包，将其复制到网卡内的缓冲区，向MAC模块发送发包命令。
2. MAC模块把包从缓冲区取出，在开头加上报头和起始帧分界符，在末尾加上检测错误的帧校验序列。让0和1分别对应特定的电压和电流。
3. 网卡的MAC模块生成通用信号，然后由PHY(MAU)模块转换为卡在网线中传输的格式，并通过网线发送出去。

## UDP协议的收发操作
数据短，一个包就能装下，未送达就重发。如果对方回复数据当作接收确认。UDP的最大数据长度为65507字节，需要让IP模块使用分片功能拆分之后再传输。

UDP不需要建立和端口连接的步骤，只要从应用程序获取的数据，在前面加上UDP头部，再交给IP进行发送即可。

遇到错误和丢包一概不管，UDP只是单纯的发送包。

### 音频和视频数据
音频和视频数据中缺少了某些包并不会产生严重的问题，只是会产生一些失真或者卡顿而已，一般都是可以接受的。在这些无需重发数据，或者重发了也没什么意义的情况下，使用UDP 发送数据的效率会更高。

----

### 信号在网线和集线器中传输

#### 集线器和交换机
- 每个包都是独立传输的。
- 局域网是用的网线是双绞线，双绞线是两根信号线纠缠在一起，为了抑制噪声。
- 集线器将信号发送给所有连接在它上面的线路。
- 交换机端口的MAC模块不具有MAC地址。
- 交换机根据MAC地址表查找MAC地址，然后将信号发送到相应的端口。
- 交换机的全双工模式可以同时发送和接收信号。

#### 路由器

路由器根据“IP地址”判断转发目标。路由器会忽略主机号，只匹配网络号。

路由器的端口都具有MAC 地址，只接收与自身地址匹配的包，遇到不匹配的包则直接丢弃。

通过路由器转发的网络包，其接收方MAC地址为路由器端口的MAC地址。路由器会根据MAC头部后方的IP头部中的内容进行包的转发操作。

路由表中子网掩码为0.0.0.0 的记录表示“默认路由”。

路由器也会使用ARP来查询下一个转发目标的MAC地址。

IP对以太网的委只是将包传输到下一个路由器就行了，当包到达下一个路由器后，下一个路由器又重新委托以太网将包传输到再下一个路由器。

IP本身不负责包的传输，而是委托各种通信技术将包传输到下一个路由器。

#### 地址
固定地址的分配。A公司和B公司的网络是独立的，地址出现重复就无关紧要了。

规定某些地址是用于内网，地址叫私有地址，原来的固定的地址叫作公网地址。

```html
私有地址，在内网中可以用作私有地址的范围:
10.0.0.0 ~ 10.255.255.255
172.16.0.0 ~ 172.31.255.255
192.168.0.0 ~ 192.168.255.255
```

如果公司内网需要和互联网连接的时候，公司内网分成两部分：
- 一部分是对互联网开放的服务器；
- 另一部分是公司的内部设备。

其中对互联网开放的服务器分配共有地址，可以和互联网直接通信。内网部分分配私有地址，内网中的设备不能和互联网直接收发网络包，而是通过一种特别的机制进行连接，地址转换。

#### 路由器的功能：地址转换

在转发网络包时对IP头部中的IP地址和端口号进行改写。

##### 内网访问互联网
首先，TCP连接操作的第一个包被转发到互联网时，将发送方IP地址从私有地址改写成公有地址（地址转换设备的互联网接入端口的地址），端口号也需要进行改写，地址转换设备会随机选择一个空闲的端口。
（跳板机？）

> 在对外只能使用一个公有地址的情况下，可以用不同的端口号来区别内网中的不同终端。

##### 互联网访问内网

从内网访问互联网，即使私网地址和端口号没有保存在对应表中也是可以进行正常转发的。端口号可以随机分配一个空闲的端口既可。

但是互联网访问公司内网，在对应表中没有记录就无法正常转发。放置非法入侵的效果。